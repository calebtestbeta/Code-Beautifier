<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ğŸ›¡ï¸ è³‡å®‰åŠ å›ºï¼šContent Security Policy (CSP) -->
    <!-- ä¿®æ­£èªªæ˜ï¼š
         1. ç§»é™¤ frame-ancestors (meta tag ä¸æ”¯æ´æ­¤å±¬æ€§)
         2. connect-src: é–‹æ”¾ cdn.jsdelivr.net èˆ‡ cdnjs.cloudflare.com ä»¥å…è¨±è¼‰å…¥ Source Maps (.map æª”æ¡ˆ)ï¼Œæ¶ˆé™¤æ§åˆ¶å°éŒ¯èª¤
    -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'none'; 
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; 
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
        font-src https://cdn.jsdelivr.net; 
        img-src 'self' data:; 
        connect-src https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    ">
    
    <title>DevBox v2.0 (Secure & Offline)</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        /* CSS è®Šæ•¸ç³»çµ± */
        :root {
            --bg-body: #1e1e1e;
            --bg-panel: #252526;
            --border-color: #3e3e42;
            --text-main: #d4d4d4;
            --text-muted: #aaaaaa;
            --header-bg: #2d2d2d;
            --accent-color: #007acc; 
            --navbar-bg: #007acc;
            --navbar-text: #ffffff;
            --input-bg: #1e1e1e;
            --input-text: #9cdcfe; 
            --output-text: #ce9178; 
            --code-font: 'Consolas', 'Monaco', 'Courier New', monospace;
            --select-bg: #3c3c3c;
            --select-color: #ffffff;
            
            /* Tree View */
            --tree-key: #9cdcfe;
            --tree-string: #ce9178;
            --tree-number: #b5cea8;
            --tree-boolean: #569cd6;
            --tree-null: #569cd6;
            --tree-hover: rgba(255, 255, 255, 0.1);
            --tree-selected: rgba(0, 122, 204, 0.3);
        }

        body.light-mode {
            --bg-body: #f3f3f3;
            --bg-panel: #ffffff;
            --border-color: #d1d5db;
            --text-main: #333333;
            --text-muted: #666666;
            --header-bg: #e9ecef;
            --accent-color: #0066b8;
            --navbar-bg: #0066b8;
            --navbar-text: #ffffff;
            --input-bg: #ffffff;
            --input-text: #0451a5; 
            --output-text: #a31515; 
            --select-bg: #ffffff;
            --select-color: #333333;
            
            /* Tree View Light */
            --tree-key: #0451a5;
            --tree-string: #a31515;
            --tree-number: #098658;
            --tree-boolean: #0000ff;
            --tree-null: #0000ff;
            --tree-hover: rgba(0, 0, 0, 0.05);
            --tree-selected: rgba(0, 102, 184, 0.2);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Navbar */
        .navbar {
            background-color: var(--navbar-bg) !important;
            color: var(--navbar-text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            transition: background-color 0.3s;
        }
        .navbar-brand { color: var(--navbar-text) !important; font-weight: bold; }

        /* Main Layout */
        .main-container {
            flex: 1;
            padding: 10px;
            display: flex;
            gap: 10px;
            height: calc(100vh - 56px);
            overflow: hidden;
        }

        @media (max-width: 1024px) {
            body { height: auto; min-height: 100vh; overflow-y: auto !important; }
            .main-container { flex-direction: column; height: auto; overflow: visible; padding-bottom: 20px; }
            .editor-panel { min-height: 400px; margin-bottom: 10px; }
            ::-webkit-scrollbar { width: 6px; }
        }

        /* Panels */
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            min-height: 300px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: background-color 0.3s, border-color 0.3s;
            position: relative;
        }

        .panel-header {
            padding: 8px 12px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            flex-shrink: 0;
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Textareas */
        .code-area {
            flex: 1;
            width: 100%;
            background-color: var(--input-bg);
            color: var(--input-text); 
            border: none;
            padding: 15px;
            font-family: var(--code-font);
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .code-area::placeholder { color: var(--text-muted); opacity: 0.6; }
        .code-area:focus { box-shadow: inset 0 0 0 1px var(--accent-color); }
        #output-code { color: var(--output-text); }

        /* JQ/Mongo Tree */
        #jq-tree-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--input-bg);
        }
        #jq-result-bar {
            padding: 10px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            font-family: var(--code-font);
            color: var(--accent-color);
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #jq-result-badge {
            background-color: var(--accent-color);
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        #jq-result-output {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-main);
            font-family: inherit;
            outline: none;
        }
        #jq-tree-view {
            flex: 1;
            padding: 15px;
            overflow: auto;
            font-family: var(--code-font);
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-main);
        }
        .json-tree ul { list-style: none; margin: 0; padding: 0 0 0 20px; }
        .json-tree > ul { padding-left: 0; }
        .json-tree li { position: relative; }
        .json-key { color: var(--tree-key); cursor: pointer; padding: 0 4px; border-radius: 3px; }
        .json-key:hover { background-color: var(--tree-hover); }
        .json-key.selected { background-color: var(--tree-selected); outline: 1px solid var(--accent-color); }
        .json-string { color: var(--tree-string); }
        .json-number { color: var(--tree-number); }
        .json-boolean { color: var(--tree-boolean); }
        .json-null { color: var(--tree-null); }
        .json-bracket { color: var(--text-muted); }

        /* Controls */
        #language-select, #lang-switcher {
            background-color: var(--select-bg);
            color: var(--select-color);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .light-mode #language-select, .light-mode #lang-switcher { border: 1px solid #ced4da; }
        optgroup { background-color: var(--select-bg); color: var(--text-muted); }
        option { background-color: var(--select-bg); color: var(--select-color); }

        .btn-theme-toggle {
            color: var(--navbar-text);
            border: 1px solid rgba(255,255,255,0.3);
            background: transparent;
        }
        .btn-theme-toggle:hover { background: rgba(255,255,255,0.1); color: #fff; }

        /* Status Bar */
        .status-bar {
            height: 24px;
            background-color: var(--accent-color);
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            justify-content: space-between;
            transition: background-color 0.3s;
            flex-shrink: 0;
        }
        .warning-badge {
            background-color: #ffc107; color: #333;
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;
            display: none; animation: fadeIn 0.3s; margin-right: 10px; font-weight: bold;
        }
        .error-badge {
            background-color: #dc3545; color: white;
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;
            display: none; animation: fadeIn 0.3s;
        }

        /* Checkbox */
        .form-check-input { cursor: pointer; border-color: rgba(255,255,255,0.5); background-color: rgba(255,255,255,0.1); }
        .form-check-input:checked { background-color: #28a745; border-color: #28a745; }
        .form-check-label { font-size: 0.85rem; cursor: pointer; user-select: none; color: var(--navbar-text); }

        .d-none { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            color: var(--text-main); transition: opacity 0.5s;
        }

        /* Toast Container */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
        .toast { background-color: var(--bg-panel); color: var(--text-main); border: 1px solid var(--border-color); }
        .toast-header { background-color: var(--header-bg); color: var(--text-main); border-bottom: 1px solid var(--border-color); }
        .btn-close { filter: invert(1); }
        .light-mode .btn-close { filter: none; }
    </style>
</head>
<body>

    <!-- Loading Mask -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <div data-i18n="loading">Loading DevBox...</div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid px-2">
            <!-- Brand -->
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-box-seam-fill fs-4 me-2"></i>
                <span>DevBox</span>
                <small class="ms-1 fw-normal opacity-50" style="font-size: 0.7rem;">v2.0</small>
                <span class="badge bg-light text-dark ms-2 opacity-75" style="font-size: 0.7rem;" data-i18n="badge_private">Private</span>
            </a>
            
            <!-- Controls -->
            <div class="d-flex align-items-center gap-2">
                <!-- Theme Toggle -->
                <button class="btn btn-sm btn-theme-toggle rounded-circle p-1" style="width: 32px; height: 32px;" onclick="UIManager.toggleTheme()">
                    <i id="theme-icon" class="bi bi-moon-stars-fill"></i>
                </button>

                <!-- Language Switcher -->
                <div class="dropdown">
                    <select id="lang-switcher" class="form-select form-select-sm shadow-none" style="width: 100px; cursor: pointer;">
                        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                    </select>
                </div>

                <div class="vr mx-1" style="color: rgba(255,255,255,0.5);"></div>

                <!-- Tool Select -->
                <select id="language-select" class="form-select form-select-sm shadow-none" style="width: 180px;">
                    <!-- Options populated by JS for i18n -->
                </select>

                <!-- Mask Secrets Checkbox -->
                <div id="mask-option" class="d-none ms-1 d-flex align-items-center">
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="maskSecrets" checked>
                        <label class="form-check-label" for="maskSecrets" data-i18n="label_mask">
                            Mask Secrets
                        </label>
                    </div>
                    <i class="bi bi-info-circle ms-2" 
                       id="mask-tooltip"
                       style="cursor: help; color: rgba(255,255,255,0.7); font-size: 0.9rem;" 
                       data-bs-toggle="tooltip" 
                       data-bs-html="true"
                       data-bs-placement="bottom"
                       title="">
                    </i>
                </div>
                
                <!-- Run Button -->
                <button class="btn btn-light btn-sm fw-bold px-3 shadow-sm" onclick="App.runFormat()">
                    <i class="bi bi-play-fill"></i> <span data-i18n="btn_run">Run</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Input Panel -->
        <div class="editor-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="bi bi-pencil-square"></i> <span data-i18n="title_input">Input</span>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm py-0" style="font-size: 0.75rem;" onclick="App.loadDemo(true)">
                        <i class="bi bi-magic"></i> <span data-i18n="btn_demo">Demo</span>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm py-0" style="font-size: 0.75rem;" onclick="App.clearAll()">
                        <i class="bi bi-trash"></i> <span data-i18n="btn_clear">Clear</span>
                    </button>
                </div>
            </div>
            <textarea id="input-code" class="code-area" placeholder="" spellcheck="false" autocomplete="off"></textarea>
        </div>

        <!-- Output Panel -->
        <div class="editor-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="bi bi-code-slash"></i> <span data-i18n="title_output">Output</span>
                    <span id="error-msg" class="error-badge ms-2"></span>
                </div>
                <!-- Action Buttons: Use Output as Input & Copy -->
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm py-0" style="font-size: 0.75rem;" onclick="App.useOutputAsInput()" title="å°‡çµæœè¨­ç‚ºè¼¸å…¥">
                        <i class="bi bi-arrow-up-circle"></i> <span data-i18n="btn_swap">Use Input</span>
                    </button>
                    <button id="btn-copy" class="btn btn-success btn-sm py-0" style="font-size: 0.75rem;" onclick="App.copyResult()">
                        <i class="bi bi-clipboard"></i> <span data-i18n="btn_copy">Copy</span>
                    </button>
                </div>
            </div>
            
            <!-- Standard Output -->
            <textarea id="output-code" class="code-area" placeholder="" spellcheck="false" autocomplete="off"></textarea>
            
            <!-- Tree View (JQ/Mongo) -->
            <div id="jq-tree-wrapper" class="d-none">
                <div id="jq-result-bar">
                    <span id="jq-result-badge" class="badge">Result</span>
                    <input type="text" id="jq-result-output" value="" readonly>
                </div>
                <div id="jq-tree-view" class="json-tree"></div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div>
            <span id="offline-warning" class="warning-badge">
                <i class="bi bi-wifi-off"></i> <span data-i18n="status_offline">Offline Mode</span>
            </span>
        </div>
        <div>
            <span data-i18n="status_ready">Ready</span>
            <span class="mx-2">|</span>
            <span>UTF-8</span>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/standalone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/parser-babel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/parser-html.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/parser-postcss.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/parser-yaml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/parser-graphql.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sql-formatter@12.2.0/dist/sql-formatter.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xml-formatter@2.6.1/dist/browser/xml-formatter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cronstrue@latest/dist/cronstrue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cron-parser@4.9.0/dist/cron-parser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <script>
        /**
         * DevBox - Refactored Structure
         */

        const AppConfig = {
            cronKeywords: {
                'every minute': '* * * * *', 'æ¯åˆ†é˜': '* * * * *',
                'every 5 minutes': '*/5 * * * *', 'æ¯5åˆ†é˜': '*/5 * * * *',
                'every hour': '0 * * * *', 'æ¯å°æ™‚': '0 * * * *',
                'daily': '0 0 * * *', 'every day': '0 0 * * *', 'æ¯å¤©': '0 0 * * *',
                'weekly': '0 0 * * 0', 'every week': '0 0 * * 0', 'æ¯é€±': '0 0 * * 0',
                'monthly': '0 0 1 * *', 'every month': '0 0 1 * *', 'æ¯æœˆ': '0 0 1 * *',
                'yearly': '0 0 1 1 *', 'every year': '0 0 1 1 *', 'æ¯å¹´': '0 0 1 1 *'
            },
            toolOptions: [
                { group: 'opt_group_format', items: [
                    {val:'json', k:'t_json'}, {val:'sql', k:'t_sql'}, {val:'xml', k:'t_xml'},
                    {val:'graphql', k:'t_graphql'}, {val:'mongodb', k:'t_mongo'},
                    {val:'html', k:'t_html'}, {val:'yaml', k:'t_yaml'}, {val:'css', k:'t_css'},
                    {val:'javascript', k:'t_js'}, {val:'curl', k:'t_curl'}
                ]},
                { group: 'opt_group_convert', items: [
                    {val:'jq-generator', k:'t_jq'}, {val:'mongodb-path-generator', k:'t_mongo_path'},
                    {val:'case-converter', k:'t_case'}, {val:'json-yaml', k:'t_json_yaml'},
                    {val:'json-to-schema', k:'t_schema'}, {val:'timestamp-converter', k:'t_time'},
                    {val:'cron-parser', k:'t_cron'}, {val:'regex-tester', k:'t_regex'}
                ]},
                { group: 'opt_group_encode', items: [
                    {val:'url-decode', k:'t_url_dec'}, {val:'url-encode', k:'t_url_enc'}, {val:'url-encode-uri', k:'t_url_enc_uri'},
                    {val:'hash-generator', k:'t_hash'}, {val:'base64-decode', k:'t_b64_dec'}, {val:'base64-encode', k:'t_b64_enc'},
                    {val:'base32-decode', k:'t_b32_dec'}, {val:'base32-encode', k:'t_b32_enc'}
                ]}
            ],
            demos: {
                'json': '{"squadName":"Super Hero Squad","active":true,"members":[{"name":"Molecule Man","age":29}]}',
                'sql': "SELECT * FROM users WHERE active = 1 ORDER BY id DESC;",
                'xml': '<?xml version="1.0"?><note><to>User</to><body>Msg</body></note>',
                'graphql': 'query GetUser($id:ID!){user(id:$id){name email}}',
                'mongodb': 'db.collection.aggregate([{$match:{status:"A"}},{$group:{_id:"$cust_id",total:{$sum:"$amount"}}}])',
                'html': '<!DOCTYPE html><html><head><title>Test</title></head><body><div class="main"><h1>Hello</h1><p>Text</p></div></body></html>',
                'css': 'body{color:#fff}',
                'yaml': 'name:     nginx\nreplicas:    3\nmetadata:\n  name: nginx\n  labels:\n    app:     nginx',
                'javascript': 'console.log("Hello");',
                'curl': `curl 'https://api.example.com' -H 'Authorization: Bearer token'`,
                'json-to-schema': '{"id": 1, "name": "Product"}',
                'json-yaml': '{"name": "test", "items": [1, 2, 3]}',
                'case-converter': 'user_id',
                'jq-generator': '{"data":{"users":[{"id":1,"name":"Alice","roles":["admin"]},{"id":2,"name":"Bob","roles":["user"]}]},"meta":{"total":2}}',
                'mongodb-path-generator': '{"_id":"6512a","user":{"profile":{"name":"Alice","age":30},"active":true},"tags":["a","b"]}',
                'timestamp-converter': '1704067200', // Fixed timestamp demo
                'hash-generator': 'password123',
                'cron-parser': '*/5 * * * *',
                'regex-tester': '/\\b\\d{4}-\\d{2}-\\d{2}\\b/g\nToday is 2023-10-27 and tomorrow is 2023-10-28.',
                'url-decode': 'https://example.com/?q=%E6%B8%AC%E8%A9%A6',
                'url-encode': 'https://example.com/?q=æ¸¬è©¦',
                'url-encode-uri': 'https://example.com/?q=æ¸¬è©¦',
                'base64-encode': 'ä¸­æ–‡æ¸¬è©¦',
                'base64-decode': '5Lit5paH5ris6Kmm',
                'base32-encode': 'test',
                'base32-decode': 'ORSXG5A='
            },
            translations: {
                "zh-TW": {
                    loading: "æ­£åœ¨åˆå§‹åŒ– DevBox...", badge_private: "å…§éƒ¨å°ˆç”¨", label_mask: "éš±è—æ•æ„Ÿè³‡è¨Š",
                    btn_run: "åŸ·è¡Œ", btn_demo: "ç¯„ä¾‹", btn_clear: "æ¸…ç©º", btn_copy: "è¤‡è£½çµæœ", btn_copy_ok: "å·²è¤‡è£½",
                    title_input: "è¼¸å…¥", title_output: "çµæœ", status_offline: "é›¢ç·šæ¨¡å¼", status_ready: "æº–å‚™å°±ç·’",
                    placeholder_input: "åœ¨æ­¤è²¼ä¸Šç¨‹å¼ç¢¼... (æˆ–æŒ‰ä¸‹ 'ç¯„ä¾‹' æŒ‰éˆ•)", placeholder_output: "çµæœå°‡é¡¯ç¤ºæ–¼æ­¤... (å¯ç·¨è¼¯)",
                    placeholder_jq: "é»æ“Šä¸‹æ–¹æ¬„ä½ç”¢ç”Ÿè·¯å¾‘... (æŒ‰ä½ Ctrl/Cmd å¯å¤šé¸)",
                    err_format: "âš ï¸ æ ¼å¼éŒ¯èª¤", err_syntax: "âš ï¸ èªæ³•éŒ¯èª¤", err_decode: "âš ï¸ è§£ç¢¼å¤±æ•—",
                    opt_group_format: "ç¨‹å¼ç¢¼æ ¼å¼åŒ–", opt_group_convert: "è³‡æ–™è½‰æ› (Converters)", opt_group_encode: "ç·¨ç¢¼ / è§£ç¢¼å·¥å…·",
                    t_json: "JSON æ ¼å¼åŒ–", t_sql: "SQL æ ¼å¼åŒ–", t_xml: "XML æ ¼å¼åŒ–", t_graphql: "GraphQL", t_mongo: "MongoDB Shell",
                    t_html: "HTML", t_yaml: "YAML", t_css: "CSS", t_js: "JavaScript", t_curl: "cURL æŒ‡ä»¤æ•´ç†",
                    t_jq: "JQ Generator (JSON)", t_mongo_path: "MongoDB Path Generator", t_case: "è®Šæ•¸å‘½åè½‰æ› (Case)",
                    t_json_yaml: "JSON <-> YAML", t_schema: "JSON to JSON Schema", t_time: "Unix æ™‚é–“æˆ³è½‰æ›",
                    t_cron: "Cron è¡¨é”å¼è§£æ", t_regex: "Regex æ¸¬è©¦", t_url_dec: "URL Decode (è§£ç¢¼)", t_url_enc: "URL Encode (å…¨éƒ¨)",
                    t_url_enc_uri: "URL Encode (ä¿ç•™ç¶²å€)", t_hash: "é›œæ¹Šç”¢ç”Ÿå™¨ (Hash)", t_b64_dec: "Base64 Decode",
                    t_b64_enc: "Base64 Encode", t_b32_dec: "Base32 Decode", t_b32_enc: "Base32 Encode",
                    cron_locale: "zh_TW", mask_tip: "å•Ÿç”¨å¾Œå°‡è‡ªå‹•éš±è—ä»¥ä¸‹ Headerï¼š<br>Authorization<br>Cookie<br>X-API-Key<br>X-Auth-Token<br>private-token<br>x-auth-key<br>http-x-lh-user-info<br><em>*mid* (åŒ…å« mid çš„æ‰€æœ‰ Key)</em>",
                    msg_demo_loaded: "ç¯„ä¾‹å·²è¼‰å…¥", msg_demo_hint: "ğŸ’¡ å·²åˆ‡æ›å·¥å…·ï¼Œé»æ“Š 'ç¯„ä¾‹' å¯æŸ¥çœ‹ç”¨æ³•",
                    btn_swap: "è¨­ç‚ºè¼¸å…¥"
                },
                "en": {
                    loading: "Loading DevBox...", badge_private: "Private", label_mask: "Mask Secrets",
                    btn_run: "Run", btn_demo: "Demo", btn_clear: "Clear", btn_copy: "Copy", btn_copy_ok: "Copied!",
                    title_input: "Input", title_output: "Output", status_offline: "Offline Mode", status_ready: "Ready",
                    placeholder_input: "Paste your code here... (or click 'Demo')", placeholder_output: "Result will appear here... (Editable)",
                    placeholder_jq: "Click fields below to generate path... (Ctrl/Cmd to multi-select)",
                    err_format: "âš ï¸ Format Error", err_syntax: "âš ï¸ Syntax Error", err_decode: "âš ï¸ Decode Failed",
                    opt_group_format: "Code Formatter", opt_group_convert: "Converters", opt_group_encode: "Encoders / Decoders",
                    t_json: "JSON Formatter", t_sql: "SQL Formatter", t_xml: "XML Formatter", t_graphql: "GraphQL", t_mongo: "MongoDB Shell",
                    t_html: "HTML", t_yaml: "YAML", t_css: "CSS", t_js: "JavaScript", t_curl: "cURL Formatter",
                    t_jq: "JQ Generator", t_mongo_path: "MongoDB Path Generator", t_case: "Case Converter",
                    t_json_yaml: "JSON <-> YAML", t_schema: "JSON to JSON Schema", t_time: "Timestamp Converter",
                    t_cron: "Cron Expression", t_regex: "Regex Tester", t_url_dec: "URL Decode", t_url_enc: "URL Encode (Full)",
                    t_url_enc_uri: "URL Encode (URI Safe)", t_hash: "Hash Generator", t_b64_dec: "Base64 Decode",
                    t_b64_enc: "Base64 Encode", t_b32_dec: "Base32 Decode", t_b32_enc: "Base32 Encode",
                    cron_locale: "en", mask_tip: "Auto-hides headers:<br>Authorization<br>Cookie<br>X-API-Key<br>X-Auth-Token<br>private-token<br>x-auth-key<br>http-x-lh-user-info<br><em>*mid* (Any key containing mid)</em>",
                    msg_demo_loaded: "Demo Loaded", msg_demo_hint: "ğŸ’¡ Tool switched. Click 'Demo' to see examples.",
                    btn_swap: "Use as Input"
                },
                "ja": {
                    loading: "DevBoxã‚’èª­ã¿è¾¼ã¿ä¸­...", badge_private: "ç¤¾å†…ç”¨", label_mask: "æ©Ÿå¯†æƒ…å ±ã‚’éš ã™",
                    btn_run: "å®Ÿè¡Œ", btn_demo: "ãƒ‡ãƒ¢", btn_clear: "ã‚¯ãƒªã‚¢", btn_copy: "ã‚³ãƒ”ãƒ¼", btn_copy_ok: "å®Œäº†",
                    title_input: "å…¥åŠ›", title_output: "çµæœ", status_offline: "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰", status_ready: "æº–å‚™å®Œäº†",
                    placeholder_input: "ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘... (ã¾ãŸã¯ 'ãƒ‡ãƒ¢' ã‚’ã‚¯ãƒªãƒƒã‚¯)", placeholder_output: "çµæœã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™... (ç·¨é›†å¯èƒ½)",
                    placeholder_jq: "ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ‘ã‚¹ã‚’ç”Ÿæˆ... (Ctrl/Cmdã§è¤‡æ•°é¸æŠ)",
                    err_format: "âš ï¸ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼", err_syntax: "âš ï¸ æ§‹æ–‡ã‚¨ãƒ©ãƒ¼", err_decode: "âš ï¸ ãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—",
                    opt_group_format: "ã‚³ãƒ¼ãƒ‰æ•´å½¢", opt_group_convert: "å¤‰æ›ãƒ„ãƒ¼ãƒ«", opt_group_encode: "ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ / ãƒ‡ã‚³ãƒ¼ãƒ‰",
                    t_json: "JSON æ•´å½¢", t_sql: "SQL æ•´å½¢", t_xml: "XML æ•´å½¢", t_graphql: "GraphQL", t_mongo: "MongoDB Shell",
                    t_html: "HTML", t_yaml: "YAML", t_css: "CSS", t_js: "JavaScript", t_curl: "cURL æ•´å½¢",
                    t_jq: "JQ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼", t_mongo_path: "MongoDB ãƒ‘ã‚¹ç”Ÿæˆ", t_case: "å¤‰æ•°åå¤‰æ› (Case)",
                    t_json_yaml: "JSON <-> YAML", t_schema: "JSON to JSON Schema", t_time: "Unix ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å¤‰æ›",
                    t_cron: "Cron å¼è§£æ", t_regex: "æ­£è¦è¡¨ç¾ãƒ†ã‚¹ã‚¿ãƒ¼", t_url_dec: "URL ãƒ‡ã‚³ãƒ¼ãƒ‰", t_url_enc: "URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ (Full)",
                    t_url_enc_uri: "URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ (URI Safe)", t_hash: "ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ (Hash)", t_b64_dec: "Base64 ãƒ‡ã‚³ãƒ¼ãƒ‰",
                    t_b64_enc: "Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰", t_b32_dec: "Base32 ãƒ‡ã‚³ãƒ¼ãƒ‰", t_b32_enc: "Base32 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰",
                    cron_locale: "ja", mask_tip: "ä»¥ä¸‹ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è‡ªå‹•çš„ã«éš ã—ã¾ã™ï¼š<br>Authorization<br>Cookie<br>X-API-Key<br>X-Auth-Token<br>private-token<br>x-auth-key<br>http-x-lh-user-info<br><em>*mid* (midã‚’å«ã‚€å…¨ã¦ã®ã‚­ãƒ¼)</em>",
                    msg_demo_loaded: "ãƒ‡ãƒ¢ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ", msg_demo_hint: "ğŸ’¡ ãƒ„ãƒ¼ãƒ«ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚ã€Œãƒ‡ãƒ¢ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¾‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚",
                    btn_swap: "å…¥åŠ›ã¸åæ˜ "
                },
                "ko": {
                    loading: "DevBox ë¡œë”© ì¤‘...", badge_private: "ë‚´ë¶€ìš©", label_mask: "ë¯¼ê° ì •ë³´ ìˆ¨ê¸°ê¸°",
                    btn_run: "ì‹¤í–‰", btn_demo: "ì˜ˆì œ", btn_clear: "ì§€ìš°ê¸°", btn_copy: "ë³µì‚¬", btn_copy_ok: "ì™„ë£Œ",
                    title_input: "ì…ë ¥", title_output: "ê²°ê³¼", status_offline: "ì˜¤í”„ë¼ì¸ ëª¨ë“œ", status_ready: "ì¤€ë¹„ë¨",
                    placeholder_input: "ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”... (ë˜ëŠ” 'ì˜ˆì œ' ë²„íŠ¼ í´ë¦­)", placeholder_output: "ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤... (ìˆ˜ì • ê°€ëŠ¥)",
                    placeholder_jq: "í•„ë“œë¥¼ í´ë¦­í•˜ì—¬ ê²½ë¡œ ìƒì„±... (Ctrl/Cmd ë‹¤ì¤‘ ì„ íƒ)",
                    err_format: "âš ï¸ í˜•ì‹ ì˜¤ë¥˜", err_syntax: "âš ï¸ ë¬¸ë²• ì˜¤ë¥˜", err_decode: "âš ï¸ ë””ì½”ë”© ì‹¤íŒ¨",
                    opt_group_format: "ì½”ë“œ í¬ë§·í„°", opt_group_convert: "ë³€í™˜ ë„êµ¬", opt_group_encode: "ì¸ì½”ë” / ë””ì½”ë”",
                    t_json: "JSON í¬ë§·í„°", t_sql: "SQL í¬ë§·í„°", t_xml: "XML í¬ë§·í„°", t_graphql: "GraphQL", t_mongo: "MongoDB Shell",
                    t_html: "HTML", t_yaml: "YAML", t_css: "CSS", t_js: "JavaScript", t_curl: "cURL í¬ë§·í„°",
                    t_jq: "JQ ìƒì„±ê¸°", t_mongo_path: "MongoDB ê²½ë¡œ ìƒì„±ê¸°", t_case: "ë³€ìˆ˜ëª… ë³€í™˜ (Case)",
                    t_json_yaml: "JSON <-> YAML", t_schema: "JSON to JSON Schema", t_time: "Unix íƒ€ì„ìŠ¤íƒ¬í”„ ë³€í™˜",
                    t_cron: "Cron í‘œí˜„ì‹ íŒŒì„œ", t_regex: "ì •ê·œì‹ í…ŒìŠ¤í„°", t_url_dec: "URL ë””ì½”ë”©", t_url_enc: "URL ì¸ì½”ë”© (ì „ì²´)",
                    t_url_enc_uri: "URL ì¸ì½”ë”© (ì£¼ì†Œ ìœ ì§€)", t_hash: "í•´ì‹œ ìƒì„± (Hash)", t_b64_dec: "Base64 ë””ì½”ë”©",
                    t_b64_enc: "Base64 ì¸ì½”ë”©", t_b32_dec: "Base32 ë””ì½”ë”©", t_b32_enc: "Base32 ì¸ì½”ë”©",
                    cron_locale: "ko", mask_tip: "ë‹¤ìŒ í—¤ë”ë¥¼ ìë™ìœ¼ë¡œ ìˆ¨ê¹ë‹ˆë‹¤:<br>Authorization<br>Cookie<br>X-API-Key<br>X-Auth-Token<br>private-token<br>x-auth-key<br>http-x-lh-user-info<br><em>*mid* (mid í¬í•¨ í‚¤)</em>",
                    msg_demo_loaded: "ì˜ˆì œê°€ ë¡œë“œë¨", msg_demo_hint: "ğŸ’¡ ë„êµ¬ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. 'ì˜ˆì œ'ë¥¼ í´ë¦­í•˜ì—¬ ì‚¬ìš©ë²•ì„ í™•ì¸í•˜ì„¸ìš”.",
                    btn_swap: "ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©"
                }
            }
        };

        /* ================= UTILS ================= */
        const Utils = {
            debounce: (func, wait) => {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            },
            basicXmlFormatter: (xml) => {
                var formatted = '';
                var reg = /(>)(<)(\/*)/g;
                xml = xml.replace(reg, '$1\r\n$2$3');
                var pad = 0;
                var nodes = xml.split('\r\n');
                for(var n in nodes) {
                    var node = nodes[n];
                    var indent = 0;
                    if (node.match(/.+<\/\w[^>]*>$/)) indent = 0;
                    else if (node.match(/^<\/\w/)) { if (pad != 0) pad -= 1; }
                    else if (node.match(/^<\w[^>]*[^\/]>.*$/)) indent = 1;
                    else indent = 0;
                    var padding = '';
                    for (var i = 0; i < pad; i++) padding += '  ';
                    formatted += padding + node + '\r\n';
                    pad += indent;
                }
                return formatted.trim();
            },
            Base32: {
                alphabet: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',
                encode: function(input) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(input);
                    let output = '';
                    let val = 0, bits = 0;
                    for (let i = 0; i < data.length; i++) {
                        val = (val << 8) | data[i];
                        bits += 8;
                        while (bits >= 5) {
                            output += this.alphabet[(val >>> (bits - 5)) & 31];
                            bits -= 5;
                        }
                    }
                    if (bits > 0) output += this.alphabet[(val << (5 - bits)) & 31];
                    while (output.length % 8 !== 0) output += '=';
                    return output;
                },
                decode: function(input) {
                    input = input.replace(/=+$/, '');
                    let output = new Uint8Array(input.length * 5 / 8 | 0);
                    let val = 0, bits = 0, index = 0;
                    for (let i = 0; i < input.length; i++) {
                        let c = this.alphabet.indexOf(input[i].toUpperCase());
                        if (c === -1) continue; 
                        val = (val << 5) | c;
                        bits += 5;
                        if (bits >= 8) {
                            output[index++] = (val >>> (bits - 8)) & 255;
                            bits -= 8;
                        }
                    }
                    const decoder = new TextDecoder();
                    return decoder.decode(output.slice(0, index));
                }
            }
        };

        /* ================= PROCESSORS ================= */
        const Processors = {
            'json': (s) => prettier.format(s, { parser: "json", plugins: Object.values(window.prettierPlugins), printWidth: 60 }),
            'javascript': (s) => prettier.format(s, { parser: "babel", plugins: Object.values(window.prettierPlugins), semi: true, singleQuote: true }),
            'mongodb': (s) => prettier.format(s, { parser: "babel", plugins: Object.values(window.prettierPlugins), semi: true, singleQuote: true }),
            'graphql': (s) => prettier.format(s, { parser: "graphql", plugins: Object.values(window.prettierPlugins) }),
            'html': (s) => prettier.format(s, { parser: "html", plugins: Object.values(window.prettierPlugins), printWidth: 100 }),
            'css': (s) => prettier.format(s, { parser: "css", plugins: Object.values(window.prettierPlugins) }),
            'yaml': (s) => prettier.format(s, { parser: "yaml", plugins: Object.values(window.prettierPlugins) }),
            'sql': (s) => sqlFormatter.format(s, { language: 'sql', indent: '  ', uppercase: true }),
            'xml': (s) => {
                let formatter = (typeof window.xmlFormatter === 'function') ? window.xmlFormatter : (window.xmlFormatter?.default);
                if (formatter) return formatter(s, { indentation: '  ', collapseContent: true, lineSeparator: '\n' });
                return Utils.basicXmlFormatter(s);
            },
            'curl': (s, mask) => {
                if (!s) return "";
                s = s.replace(/\\\s*\n/g, " ").replace(/\s+/g, " ").trim();
                const regex = /(".*?"|'.*?'|-[^\s]+|--[^\s]+|[^\s]+)/g;
                const tokens = s.match(regex) || [];
                let formatted = "";
                const sensitiveKeys = ['Authorization', 'Cookie', 'X-API-Key', 'X-Auth-Token', 'private-token', 'x-auth-key', 'http-x-lh-user-info'];
                tokens.forEach((token, index) => {
                    if (mask) {
                        let cleanToken = token.replace(/^['"]|['"]$/g, '');
                        if (cleanToken.includes(':')) {
                            const parts = cleanToken.split(':');
                            const key = parts[0].trim();
                            let isSensitive = sensitiveKeys.some(k => k.toLowerCase() === key.toLowerCase()) || key.toLowerCase().includes('mid');
                            if (isSensitive) {
                                const firstChar = token[0];
                                const quote = (firstChar === '"' || firstChar === "'") ? firstChar : "'";
                                token = `${quote}${key}: ********${quote}`;
                            }
                        }
                    }
                    if (index === 0) formatted += token; 
                    else if (token.startsWith("-")) formatted += " \\\n  " + token;
                    else formatted += " " + token;
                });
                return formatted;
            },
            'case-converter': (s) => {
                if (!s) return "";
                const cleanInput = s.trim();
                const words = cleanInput.replace(/([a-z])([A-Z])/g, '$1 $2').replace(/[_-]/g, ' ').toLowerCase().split(/\s+/).filter(w => w.length > 0);
                if (words.length === 0) return "";
                const camel = words.map((w, i) => i === 0 ? w : w.charAt(0).toUpperCase() + w.slice(1)).join('');
                const pascal = words.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('');
                const snake = words.join('_');
                const kebab = words.join('-');
                const constant = words.join('_').toUpperCase();
                const sentence = words.join(' ').charAt(0).toUpperCase() + words.join(' ').slice(1);
                return `Input: ${s}\n\nCamel Case:    ${camel}\nPascal Case:   ${pascal}\nSnake Case:    ${snake}\nKebab Case:    ${kebab}\nConstant Case: ${constant}\nSentence Case: ${sentence}`;
            },
            'json-yaml': (s) => {
                const trimmed = s.trim();
                try {
                    const obj = JSON.parse(trimmed);
                    if(typeof jsyaml !== 'undefined') return jsyaml.dump(obj);
                    throw new Error("JS-YAML Lib missing");
                } catch (eJson) {
                    try {
                        if(typeof jsyaml !== 'undefined') {
                            const obj = jsyaml.load(trimmed);
                            return JSON.stringify(obj, null, 2);
                        } throw new Error("JS-YAML Lib missing");
                    } catch (eYaml) {
                        throw new Error("Invalid JSON or YAML");
                    }
                }
            },
            'json-to-schema': (s) => {
                function getType(v) { if (v === null) return 'null'; if (Array.isArray(v)) return 'array'; return typeof v; }
                function traverse(data) {
                    const type = getType(data);
                    const schema = { type };
                    if (type === 'object') {
                        schema.properties = {};
                        for (const key in data) schema.properties[key] = traverse(data[key]);
                    } else if (type === 'array') {
                        if (data.length > 0) schema.items = traverse(data[0]);
                        else schema.items = {}; 
                    }
                    return schema;
                }
                const jsonObj = JSON.parse(s);
                const schemaObj = { "$schema": "http://json-schema.org/draft-07/schema#", ...traverse(jsonObj) };
                return prettier.format(JSON.stringify(schemaObj), { parser: "json", plugins: Object.values(window.prettierPlugins), printWidth: 60 });
            },
            'timestamp-converter': (s) => {
                let date;
                let raw = s.trim();
                if (!raw) date = new Date(); 
                else if (/^-?\d+$/.test(raw)) { 
                    if (Math.abs(parseInt(raw)) < 100000000000) date = new Date(parseInt(raw) * 1000); 
                    else date = new Date(parseInt(raw)); 
                } else date = new Date(raw);
                
                if (isNaN(date.getTime())) throw new Error("Invalid Date");
                const now = new Date();
                const diffMs = now - date;
                const diffMin = Math.round(diffMs / 60000);
                let relative = "";
                if (Math.abs(diffMin) < 1) relative = "Just now";
                else if (diffMin > 0) relative = `${diffMin} mins ago`;
                else relative = `in ${Math.abs(diffMin)} mins`;
                let formatted = `Local Time:      ${date.toLocaleString()}\n`;
                formatted += `ISO 8601 (UTC):  ${date.toISOString()}\n`;
                formatted += `Unix (Seconds):  ${Math.floor(date.getTime() / 1000)}\n`;
                formatted += `Unix (Millis):   ${date.getTime()}\n`;
                formatted += `Relative:        ${relative}`;
                return formatted;
            },
            'hash-generator': async (s) => {
                if (!s) return "";
                const encoder = new TextEncoder();
                const data = encoder.encode(s);
                const algos = ['SHA-1', 'SHA-256', 'SHA-384', 'SHA-512'];
                let result = "";
                for (let algo of algos) {
                    const hashBuffer = await crypto.subtle.digest(algo, data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    result += `${algo}:\n${hashHex}\n\n`;
                }
                return result.trim();
            },
            'cron-parser': (s, locale) => {
                let cronExp = s.trim();
                const lowerSource = cronExp.toLowerCase();
                if (AppConfig.cronKeywords[lowerSource]) {
                    cronExp = AppConfig.cronKeywords[lowerSource];
                }
                let output = "";
                let validCron = false;
                if (typeof cronstrue !== 'undefined') {
                    try {
                        const loc = locale || 'en';
                        const desc = cronstrue.toString(cronExp, { locale: loc });
                        output += `Description:\n${desc}\n\n`;
                        validCron = true;
                    } catch(e) {}
                }
                if (typeof cronParser !== 'undefined' && validCron) {
                    try {
                        const interval = cronParser.parseExpression(cronExp);
                        output += `Next 5 Runs:\n`;
                        for (let i = 0; i < 5; i++) output += `${i+1}. ${interval.next().toString()}\n`;
                    } catch (e) {}
                }
                if (!validCron) {
                    output = `âš ï¸ Invalid Cron Expression.\n\nExamples:\n* * * * * (Every Minute)\n*/5 * * * * (Every 5 Min)\n0 0 1 * * (Monthly)`;
                }
                return output;
            },
            'regex-tester': (s) => {
                const lines = s.split('\n');
                if (lines.length < 2) return "RegEx: /pattern/flags\nText: ...";
                let regexStr = lines[0].trim();
                const textToTest = s.substring(s.indexOf('\n') + 1);
                let pattern = regexStr;
                let flags = "";
                if (regexStr.startsWith('/') && regexStr.lastIndexOf('/') > 0) {
                    const lastSlash = regexStr.lastIndexOf('/');
                    pattern = regexStr.substring(1, lastSlash);
                    flags = regexStr.substring(lastSlash + 1);
                }
                try {
                    const regex = new RegExp(pattern, flags || 'g');
                    let output = `Pattern: /${pattern}/${flags}\n\n`;
                    const matches = [...textToTest.matchAll(regex)];
                    if (matches.length === 0) return output + "No matches found.";
                    output += `Found ${matches.length} matches:\n\n`;
                    matches.forEach((m, i) => {
                        output += `Match ${i + 1}: "${m[0]}" (Index: ${m.index})\n`;
                        if (m.length > 1) {
                            m.slice(1).forEach((group, gIndex) => {
                                output += `  Group ${gIndex + 1}: "${group}"\n`;
                            });
                        }
                        output += "\n";
                    });
                    return output.trim();
                } catch (e) {
                    return `Regex Error: ${e.message}`;
                }
            },
            'url-decode': (s) => {
                let f = decodeURIComponent(s);
                if (f.includes('&') && f.includes('=')) try { f = f.replace(/&/g, '\n&').replace(/\?/g, '\n?'); } catch (e) {}
                return f;
            },
            'url-encode': (s) => encodeURIComponent(s),
            'url-encode-uri': (s) => encodeURI(s),
            'base64-encode': (s) => btoa(unescape(encodeURIComponent(s))),
            'base64-decode': (s) => decodeURIComponent(escape(atob(s.trim()))),
            'base32-encode': (s) => Utils.Base32.encode(s),
            'base32-decode': (s) => Utils.Base32.decode(s.trim())
        };

        /* ================= UI MANAGER ================= */
        const UIManager = {
            elements: {
                input: document.getElementById('input-code'),
                output: document.getElementById('output-code'),
                langSelect: document.getElementById('language-select'),
                langSwitcher: document.getElementById('lang-switcher'),
                errorMsg: document.getElementById('error-msg'),
                jqWrapper: document.getElementById('jq-tree-wrapper'),
                jqView: document.getElementById('jq-tree-view'),
                jqOut: document.getElementById('jq-result-output'),
                jqBadge: document.getElementById('jq-result-badge'),
                maskOption: document.getElementById('mask-option'),
                maskCheckbox: document.getElementById('maskSecrets'),
                maskTooltip: document.getElementById('mask-tooltip'),
                themeIcon: document.getElementById('theme-icon'),
                loadingOverlay: document.getElementById('loading-overlay'),
                toastContainer: document.getElementById('toast-container')
            },
            state: {
                currentLang: 'zh-TW',
                lastLoadedDemoContent: "",
                selectedJqPaths: [],
                bsMaskTooltip: null
            },
            init() {
                // Theme
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'light') {
                    document.body.classList.add('light-mode');
                    this.updateThemeIcon(true);
                }
                
                // Lang
                const browserLang = navigator.language || navigator.userLanguage; 
                if (browserLang.includes('en')) this.state.currentLang = 'en';
                else if (browserLang.includes('ja')) this.state.currentLang = 'ja';
                else if (browserLang.includes('ko')) this.state.currentLang = 'ko';
                this.elements.langSwitcher.value = this.state.currentLang;
                
                this.updateInterfaceLanguage();
                
                // Overlay
                this.elements.loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    this.elements.loadingOverlay.style.display = 'none';
                    App.loadDemo(true); 
                }, 500);
            },
            updateInterfaceLanguage() {
                const t = AppConfig.translations[this.state.currentLang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (t[key]) el.innerText = t[key];
                });
                
                this.elements.input.placeholder = t.placeholder_input;
                this.elements.output.placeholder = t.placeholder_output;
                this.elements.jqOut.placeholder = t.placeholder_jq;
                
                const currentVal = this.elements.langSelect.value;
                this.elements.langSelect.innerHTML = '';
                
                AppConfig.toolOptions.forEach(group => {
                    const optGroup = document.createElement('optgroup');
                    optGroup.label = t[group.group];
                    group.items.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.val;
                        opt.innerText = t[item.k];
                        optGroup.appendChild(opt);
                    });
                    this.elements.langSelect.appendChild(optGroup);
                });
                this.elements.langSelect.value = currentVal || 'json';

                if (this.state.bsMaskTooltip) this.state.bsMaskTooltip.dispose();
                this.elements.maskTooltip.setAttribute('data-bs-original-title', t.mask_tip);
                this.state.bsMaskTooltip = new bootstrap.Tooltip(this.elements.maskTooltip);
            },
            toggleTheme() {
                const isLight = document.body.classList.toggle('light-mode');
                localStorage.setItem('theme', isLight ? 'light' : 'dark');
                this.updateThemeIcon(isLight);
            },
            updateThemeIcon(isLight) {
                this.elements.themeIcon.className = isLight ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
            },
            toggleViewComponents(lang) {
                // JQ View
                if (lang === 'jq-generator' || lang === 'mongodb-path-generator') {
                    this.elements.output.classList.add('d-none');
                    this.elements.jqWrapper.classList.remove('d-none');
                    this.elements.jqBadge.innerText = (lang === 'jq-generator') ? "JQ Path" : "Mongo Path";
                } else {
                    this.elements.output.classList.remove('d-none');
                    this.elements.jqWrapper.classList.add('d-none');
                }
                // Mask Option
                if (lang === 'curl') this.elements.maskOption.classList.remove('d-none');
                else this.elements.maskOption.classList.add('d-none');
            },
            showToast(message, type = 'info') {
                const toastId = 'toast-' + Date.now();
                const colorClass = type === 'success' ? 'text-success' : (type === 'error' ? 'text-danger' : 'text-primary');
                const html = `
                    <div id="${toastId}" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body ${colorClass}">
                                ${message}
                            </div>
                            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                this.elements.toastContainer.insertAdjacentHTML('beforeend', html);
                const toastEl = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            },
            renderTree(data, path = '') {
                const type = data === null ? 'null' : Array.isArray(data) ? 'array' : typeof data;
                if (type === 'object') {
                    let html = '<ul>';
                    for (const key in data) {
                        const safeKey = /^[a-zA-Z0-9_]+$/.test(key) ? `.${key}` : `."${key}"`;
                        const currentPath = path + safeKey;
                        html += `<li><span class="json-key" data-path="${currentPath}" onclick="App.handleTreeClick(event, '${currentPath}')">"${key}"</span>: ${this.renderTree(data[key], currentPath)}</li>`;
                    }
                    html += '</ul>';
                    return `<span class="json-bracket">{</span>${html}<span class="json-bracket">}</span>`;
                } else if (type === 'array') {
                    let html = '<ul>';
                    data.forEach((item, index) => {
                        const currentPath = `${path}[${index}]`;
                        html += `<li><span class="json-bracket" style="cursor:pointer" onclick="App.handleTreeClick(event, '${currentPath}')">[${index}]</span>: ${this.renderTree(item, currentPath)}</li>`;
                    });
                    html += '</ul>';
                    return `<span class="json-bracket">[</span>${html}<span class="json-bracket">]</span>`;
                } else {
                    let displayValue = JSON.stringify(data);
                    return `<span class="json-${type}">${displayValue}</span>`;
                }
            }
        };

        /* ================= APP LOGIC ================= */
        const App = {
            init() {
                UIManager.init();
                
                // Event Listeners
                UIManager.elements.input.addEventListener('input', Utils.debounce(() => this.runFormat(), 300));
                UIManager.elements.maskCheckbox.addEventListener('change', () => this.runFormat());
                UIManager.elements.langSwitcher.addEventListener('change', (e) => {
                    UIManager.state.currentLang = e.target.value;
                    UIManager.updateInterfaceLanguage();
                    this.checkAndLoadDemo();
                });
                UIManager.elements.langSelect.addEventListener('change', () => {
                    this.handleToolChange();
                });
                
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') this.runFormat();
                });
            },
            
            handleToolChange() {
                const lang = UIManager.elements.langSelect.value;
                UIManager.toggleViewComponents(lang);
                
                const currentInput = UIManager.elements.input.value;
                
                // SMART SWITCH: 
                // If input is empty OR input matches the last auto-loaded demo -> load new demo
                if (!currentInput.trim() || currentInput === UIManager.state.lastLoadedDemoContent) {
                    this.loadDemo(true); // forceRun=true to show formatted result immediately
                } else {
                    // User has modified input, don't overwrite.
                    // Show Tip Toast
                    const t = AppConfig.translations[UIManager.state.currentLang];
                    UIManager.showToast(t.msg_demo_hint, 'info');
                    // Just re-run format with current input for new tool
                    this.runFormat();
                }
            },

            checkAndLoadDemo() {
                // Used when lang switches, if content is untouched, update demo text to new lang
                if (UIManager.elements.input.value.trim() === UIManager.state.lastLoadedDemoContent) {
                    this.loadDemo(false);
                } else {
                    this.runFormat();
                }
            },

            loadDemo(forceRun = true) {
                const lang = UIManager.elements.langSelect.value;
                let demoText = AppConfig.demos[lang];
                
                // I18n Demo adjustments
                if (lang === 'base64-encode' && UIManager.state.currentLang !== 'zh-TW') {
                    demoText = "Testing 123";
                }

                if (lang === 'timestamp-converter' && !demoText) {
                    UIManager.elements.input.value = ""; 
                    UIManager.state.lastLoadedDemoContent = "";
                } else {
                    if (demoText === undefined) demoText = "";
                    UIManager.elements.input.value = demoText;
                    UIManager.state.lastLoadedDemoContent = demoText; 
                }
                
                if (forceRun) {
                    this.runFormat();
                    // Feedback on button
                    const btn = document.querySelector('.btn-outline-primary');
                    const t = AppConfig.translations[UIManager.state.currentLang];
                    // FIX: Restore span with data-i18n so future language switches work
                    btn.innerHTML = '<i class="bi bi-check"></i>';
                    setTimeout(() => {
                        btn.innerHTML = `<i class="bi bi-magic"></i> <span data-i18n="btn_demo">${t.btn_demo}</span>`;
                    }, 1000);
                }
            },

            async runFormat() {
                const lang = UIManager.elements.langSelect.value;
                const source = UIManager.elements.input.value;
                const outputEl = UIManager.elements.output;
                const errorMsg = UIManager.elements.errorMsg;
                const t = AppConfig.translations[UIManager.state.currentLang];

                errorMsg.style.display = 'none';
                
                // JQ Mode special handling
                if (lang === 'jq-generator' || lang === 'mongodb-path-generator') {
                    if (!source.trim()) {
                        UIManager.elements.jqView.innerHTML = '';
                        return;
                    }
                    try {
                        const data = JSON.parse(source);
                        UIManager.state.selectedJqPaths = [];
                        UIManager.elements.jqOut.value = '';
                        UIManager.elements.jqView.innerHTML = UIManager.renderTree(data, '');
                    } catch(e) {
                        UIManager.elements.jqView.innerHTML = `<div class="text-danger p-3">${t.err_syntax}: ${e.message}</div>`;
                    }
                    return;
                }

                // Standard Mode
                if (!source.trim() && lang !== 'timestamp-converter') {
                    outputEl.value = "";
                    return;
                }

                try {
                    let formatted = "";
                    const processor = Processors[lang];
                    
                    if (processor) {
                        // Handle Async vs Sync
                        if (lang === 'hash-generator') {
                            formatted = await processor(source);
                        } else if (lang === 'curl') {
                            formatted = processor(source, UIManager.elements.maskCheckbox.checked);
                        } else if (lang === 'cron-parser') {
                            // Needs extra arg for locale
                            formatted = processor(source, t.cron_locale);
                        } else {
                            formatted = processor(source);
                        }
                    } else {
                        formatted = source; // Fallback
                    }
                    
                    outputEl.value = formatted;
                } catch (err) {
                    errorMsg.style.display = 'inline-block';
                    errorMsg.innerText = (lang.includes('decode') || lang === 'timestamp-converter') ? t.err_format : t.err_syntax;
                }
            },

            copyResult() {
                const lang = UIManager.elements.langSelect.value;
                let targetEl = UIManager.elements.output;
                
                if (lang === 'jq-generator' || lang === 'mongodb-path-generator') {
                    targetEl = UIManager.elements.jqOut;
                }

                if (!targetEl.value) return;
                
                // Fallback copy
                targetEl.select();
                document.execCommand('copy');
                
                const t = AppConfig.translations[UIManager.state.currentLang];
                UIManager.showToast(t.btn_copy_ok, 'success');
            },

            // New feature: Use Output As Input
            useOutputAsInput() {
                const lang = UIManager.elements.langSelect.value;
                let valToCopy = "";

                if (lang === 'jq-generator' || lang === 'mongodb-path-generator') {
                    valToCopy = UIManager.elements.jqOut.value;
                } else {
                    valToCopy = UIManager.elements.output.value;
                }

                if (!valToCopy) return;

                UIManager.elements.input.value = valToCopy;
                // Important: Mark content as modified so it doesn't get wiped by demo switch
                UIManager.state.lastLoadedDemoContent = null; 
                
                // Optional: Flash input to indicate change
                UIManager.elements.input.focus();
                UIManager.elements.input.style.transition = 'none';
                UIManager.elements.input.style.backgroundColor = 'var(--accent-color)';
                setTimeout(() => {
                    UIManager.elements.input.style.transition = 'background-color 0.5s';
                    UIManager.elements.input.style.backgroundColor = '';
                }, 50);
            },

            clearAll() {
                UIManager.elements.input.value = '';
                UIManager.elements.output.value = '';
                UIManager.elements.jqOut.value = '';
                UIManager.elements.jqView.innerHTML = '';
                UIManager.state.selectedJqPaths = [];
                UIManager.elements.errorMsg.style.display = 'none';
                UIManager.elements.input.focus();
            },

            handleTreeClick(event, path) {
                event.stopPropagation(); 
                const target = event.target;
                const mode = UIManager.elements.langSelect.value;
                let paths = UIManager.state.selectedJqPaths;
                
                if (event.ctrlKey || event.metaKey) {
                    if (paths.includes(path)) {
                        paths = paths.filter(p => p !== path);
                        target.classList.remove('selected');
                    } else {
                        paths.push(path);
                        target.classList.add('selected');
                    }
                } else {
                    document.querySelectorAll('.json-key.selected, .json-bracket.selected').forEach(el => el.classList.remove('selected'));
                    paths = [path];
                    target.classList.add('selected');
                }
                UIManager.state.selectedJqPaths = paths;

                // Generate Output
                let outVal = "";
                if (paths.length === 0) outVal = "";
                else if (paths.length === 1) {
                    outVal = (mode === 'mongodb-path-generator') ? this.toMongoPath(paths[0]) : paths[0];
                } else {
                    // Multi
                    if (mode === 'mongodb-path-generator') {
                        const parts = paths.map(p => `"${this.toMongoPath(p)}": 1`);
                        outVal = `{ ${parts.join(', ')} }`;
                    } else {
                        const parts = paths.map(p => {
                            const match = p.match(/\.([a-zA-Z0-9_]+)$/) || p.match(/\[(\d+)\]$/);
                            let key = match ? match[1] : `field${Math.floor(Math.random()*100)}`;
                            return `${key}: ${p}`;
                        });
                        outVal = `{ ${parts.join(', ')} }`;
                    }
                }
                UIManager.elements.jqOut.value = outVal;
                // Sync to output for copy logic fallback
                UIManager.elements.output.value = outVal;
            },

            toMongoPath(jqPath) {
                return jqPath.replace(/^\./, '').replace(/\[(\d+)\]/g, '.$1').replace(/\."([^"]+)"/g, '.$1');
            }
        };

        // Initialize
        App.init();

    </script>
</body>
</html>
